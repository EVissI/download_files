<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backgammon Board Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background-color: #1a1a1a;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 5vh;
        }

        h1 {
            display: none;
        }

        .board-wrapper {
            position: relative;
            flex: 1;
        }

        canvas {
            border: 0.125rem solid #333;
            border-radius: 0.5rem;
            background-color: #2a2a2a;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: block;
        }

        .dropdown {
            position: absolute;
            font-size: 0.8rem;
        }

        select {
            font-family: Arial, sans-serif;
            font-size: 0.8rem;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            padding: 0.125rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin: 1.25rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        .nickname_inputs {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 70%;
            margin-bottom: 0.5rem;
        }

        .nickname_inputs div {
            display: flex;
            align-items: center;
            margin-bottom: 0.625rem;
        }

        .nickname_inputs label {
            color: white;
            margin-right: 0.625rem;
            font-size: 0.8rem;
            width: 5rem;
            text-align: left;
            flex-shrink: 0;
        }

        .nickname_inputs input {
            flex: 1;
            padding: 0.3125rem;
            font-size: 0.8rem;
            text-align: center;
            border: 1px solid #444;
            border-radius: 0.25rem;
            background-color: #2d2d2d;
            color: white;
        }

        @media (min-width: 768px) {
            .nickname_inputs label {
                font-size: 1.2rem;
                width: 6rem;
                margin-right: 0.75rem;
            }

            .nickname_inputs input {
                font-size: 1.2rem;
                padding: 0.4rem;
            }

            .nickname_inputs div {
                margin-bottom: 0.75rem;
            }

            .nickname_inputs {
                margin-bottom: 0.6rem;
            }

            .score-inputs label {
                font-size: 1.2rem;
                width: 10rem;
            }

            .score-inputs input {
                font-size: 1.2rem;
                padding: 0.4rem;
            }

            .crawford-options label {
                font-size: 1.2rem;
            }

            .crawford-options div label {
                font-size: 1.2rem;
            }
        }

        @media (min-width: 1200px) {
            .nickname_inputs label {
                font-size: 1.5rem;
                width: 7rem;
                margin-right: 1rem;
            }

            .nickname_inputs input {
                font-size: 1.5rem;
                padding: 0.5rem;
            }

            .nickname_inputs div {
                margin-bottom: 1rem;
            }

            .nickname_inputs {
                margin-bottom: 0.8rem;
            }

            .score-inputs label {
                font-size: 1.5rem;
                width: 12rem;
            }

            .score-inputs input {
                font-size: 1.5rem;
                padding: 0.5rem;
            }

            .crawford-options label {
                font-size: 1.5rem;
            }

            .crawford-options div label {
                font-size: 1.5rem;
            }
        }

        .selectors-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
        }

        .selectors-container {
            position: relative;
            min-height: 4.8rem;
            max-width: 60%;
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
        }

        .game-type {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            max-width: 40%;
            margin: 0 auto;
        }

        .game-type label {
            color: white;
            font-size: 0.96rem;
            width: 100%;
            text-align: center;
        }

        .game-type select {
            font-family: Arial, sans-serif;
            font-size: 0.96rem;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            padding: 0.125rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        @media (min-width: 768px) {
            .game-type label {
                font-size: 1.44rem;
            }

            .game-type select {
                font-size: 1.2rem;
            }
        }

        @media (min-width: 1200px) {
            .game-type label {
                font-size: 1.8rem;
            }

            .game-type select {
                font-size: 1.44rem;
            }
        }

        .checker-selector {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }



        .checker-selector label {
            color: white;
            font-size: 0.96rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media (min-width: 768px) {
            .checker-selector label {
                font-size: 1.44rem;
            }
        }

        @media (min-width: 1200px) {
            .checker-selector label {
                font-size: 1.8rem;
            }
        }

        .bar-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: white;
        }

        .bar-selector .selectors {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .bar-selector .selectors div {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.1rem;
        }

        .bar-selector label {
            font-size: 0.96rem;
            width: 60px;
        }

        .bar-selector select {
            font-size: 0.96rem;
            width: 60px;
            background-color: #2d2d2d;
            color: white;
            border: 1px solid #444;
            border-radius: 0.25rem;
            text-align: center;
        }

        @media (min-width: 768px) {
            .bar-selector label {
                font-size: 1.2rem;
                width: 72px;
            }

            .bar-selector select {
                font-size: 1.2rem;
                width: 72px;
            }
        }

        @media (min-width: 1200px) {
            .bar-selector label {
                font-size: 1.44rem;
                width: 84px;
            }

            .bar-selector select {
                font-size: 1.44rem;
                width: 84px;
            }
        }

        .bar-label {
            color: white;
            font-size: 0.96rem;
            text-align: center;
        }

        .checker-label {
            color: white;
            font-size: 0.96rem;
            text-align: center;
            align-self: center;
        }

        .match-panel {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .score-inputs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .score-inputs div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-inputs label {
            color: white;
            font-size: 0.8rem;
            width: 8rem;
            text-align: left;
            flex-shrink: 0;
        }

        .score-inputs input {
            flex: 1;
            padding: 0.3125rem;
            font-size: 0.8rem;
            text-align: center;
            border: 1px solid #444;
            border-radius: 0.25rem;
            background-color: #2d2d2d;
            color: white;
        }

        .crawford-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .crawford-options label {
            color: white;
            font-size: 0.8rem;
        }

        .crawford-options div {
            display: flex;
            gap: 0.5rem;
        }

        .crawford-options div label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
        }

        @media (min-width: 768px) {}

        @media (min-width: 1200px) {}
    </style>
</head>

<body>
    <div class="container">
        <h1>Backgammon Board Editor</h1>
        <div class="nickname_inputs">
            <div>
                <label for="white-input">Белые:</label>
                <input type="text" id="white-input" value="nick_1">
            </div>
            <div>
                <label for="black-input">Черные:</label>
                <input type="text" id="black-input" value="nick_2">
            </div>
        </div>
        <div class="board-wrapper">
            <canvas id="boardCanvas" width="800" height="800"></canvas>
        </div>
        <div class="selectors-wrapper">
            <div class="selectors-container">
                <div class="checker-selector">
                    <div class="checker-label">Шашки:</div>
                    <label><input type="radio" name="checkerColor" value="white" checked> Белые</label>
                    <label><input type="radio" name="checkerColor" value="black"> Черные</label>
                </div>
                <div class="bar-selector">
                    <div class="bar-label">На баре:</div>
                    <div class="selectors">
                        <div>
                            <label for="white-bar-select">Белый:</label>
                            <select id="white-bar-select">
                                <option value="0">0</option>
                            </select>
                        </div>
                        <div>
                            <label for="black-bar-select">Черный:</label>
                            <select id="black-bar-select">
                                <option value="0">0</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="game-type">
                <label for="game-type-select">Тип игры</label>
                <select id="game-type-select">
                    <option value="манигейм">манигейм</option>
                    <option value="матч">матч</option>
                </select>
                <div class="match-panel" style="display: none;">
                    <div class="score-inputs">
                        <div>
                            <label for="lower-score">Очки нижнего игрока:</label>
                            <input type="number" id="lower-score" min="0">
                        </div>
                        <div>
                            <label for="upper-score">Очки верхнего игрока:</label>
                            <input type="number" id="upper-score" min="0">
                        </div>
                    </div>
                    <div class="crawford-options">
                        <label>Crawford rule:</label>
                        <div>
                            <label><input type="checkbox" name="crawford" value="0"> 0</label>
                            <label><input type="checkbox" name="crawford" value="1"> 1</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    let positions = {
        first: { '1': 0, '12': 0, '17': 0, '19': 0, 'bar': 0, 'off': 0 },
        second: { '6': 0, '8': 0, '13': 0, '24': 0, 'bar': 0, 'off': 0 }
    };

    const canvas = document.getElementById('boardCanvas');
    const ctx = canvas.getContext('2d');
    const boardWrapper = document.querySelector('.board-wrapper');

    // Load images
    const boardImg = new Image();
    boardImg.src = '/static/board.png';
    const whiteChecker = new Image();
    whiteChecker.src = '/static/white_checker.png';
    const blackChecker = new Image();
    blackChecker.src = '/static/black_checker.png';

    function getX(point) {
        if (point >= 13 && point <= 18) {
            const baseX = 50 + (point - 13) * 60;
            return baseX - (point === 13 ? 8 : 0);
        } else if (point >= 19 && point <= 24) {
            return 450 + (point - 19) * 60;
        } else if (point >= 7 && point <= 12) {
            const baseX = 50 + (12 - point) * 60;
            return baseX - (point === 12 ? 4 : 0);
        } else if (point >= 1 && point <= 6) {
            return 450 + (6 - point) * 60;
        }
        return 0;
    }

    function getBaseY(point) {
        return (point > 12) ? 70 : 690;
    }

    function updateSelectOptions(color) {
        const targetPositions = color === 'white' ? positions.first : positions.second;
        const otherPositions = color === 'white' ? positions.second : positions.first;
        const totalCheckers = getTotalCheckers(targetPositions);
        for (let point = 1; point <= 24; point++) {
            const select = document.getElementById(`point-${point}`);
            if (!select) continue;
            const currentOnPoint = parseInt(select.value) || 0;
            const occupiedByOther = otherPositions[point.toString()] > 0;
            const baseMax = occupiedByOther ? 0 : 15;
            const maxForThis = Math.min(baseMax, 15 - (totalCheckers - currentOnPoint));
            select.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                select.appendChild(option);
            }
            select.value = currentOnPoint;
        }
    }

    function updateBarSelects() {
        const whiteBarSelect = document.getElementById('white-bar-select');
        const blackBarSelect = document.getElementById('black-bar-select');
        if (whiteBarSelect) {
            const currentBar = parseInt(whiteBarSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.first);
            const maxForThis = 15 - (totalCheckers - currentBar);
            whiteBarSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                whiteBarSelect.appendChild(option);
            }
            whiteBarSelect.value = currentBar;
        }
        if (blackBarSelect) {
            const currentBar = parseInt(blackBarSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.second);
            const maxForThis = 15 - (totalCheckers - currentBar);
            blackBarSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                blackBarSelect.appendChild(option);
            }
            blackBarSelect.value = currentBar;
        }
    }

    function updateOffSelects() {
        const whiteOffSelect = document.getElementById('white-off-select');
        const blackOffSelect = document.getElementById('black-off-select');
        if (whiteOffSelect) {
            const currentOff = parseInt(whiteOffSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.first);
            const maxForThis = 15 - (totalCheckers - currentOff);
            whiteOffSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                whiteOffSelect.appendChild(option);
            }
            whiteOffSelect.value = currentOff;
        }
        if (blackOffSelect) {
            const currentOff = parseInt(blackOffSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.second);
            const maxForThis = 15 - (totalCheckers - currentOff);
            blackOffSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                blackOffSelect.appendChild(option);
            }
            blackOffSelect.value = currentOff;
        }
    }

    function createDropdowns() {
        const scale = canvas.offsetWidth / 800;
        for (let point = 1; point <= 24; point++) {
            const select = document.createElement('select');
            select.id = `point-${point}`;
            select.className = 'dropdown';
            // Options will be set by updateSelectOptions
            select.value = 0;

            updateDropdownPosition(select, point, scale);

            // Add event listener to update board on change
            select.addEventListener('change', updateBoard);

            boardWrapper.appendChild(select);
        }
        updateSelectOptions('white'); // Default
        updateBarSelects();
        updateOffSelects();
        updateOffSelects();
    }

    function updateDropdownPosition(select, point, scale) {
        const x = (getX(point) - (point > 12 ? 25 : 25)) * scale;
        let y_text;
        if (point > 12) {
            y_text = 20;
        } else {
            y_text = 750;
        }
        const offset = point > 12 ? -70 : 20;
        const y = (y_text + offset) * scale;
        select.style.left = x + 'px';
        select.style.top = y + 'px';
        select.style.width = (55 * scale) + 'px';
        select.style.height = (55 * scale) + 'px';
        select.style.fontSize = (26 * scale) + 'px';
    }

    function updateAllDropdownPositions() {
        const scale = canvas.offsetWidth / 800;
        for (let point = 1; point <= 24; point++) {
            const select = document.getElementById(`point-${point}`);
            if (select) {
                updateDropdownPosition(select, point, scale);
            }
        }
    }

    function drawCheckers(player, img, positions, currentPlayer) {
        ctx.font = 'bold 1.875rem Arial';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (player === currentPlayer) {
            for (let point = 1; point <= 24; point++) {
                const x = getX(point);
                let y = getBaseY(point);
                const dy = getDy(point);

                let displayPoint = point;
                ctx.fillText(displayPoint, x, point > 12 ? y - 50 : y + 60);
            }
        }

        for (let pointStr in positions) {
            if (pointStr === 'bar' || pointStr === 'off') continue;
            const point = parseInt(pointStr);
            let count = positions[pointStr];
            const x = getX(point);
            let y = getBaseY(point);
            const dy = getDy(point);

            for (let i = 0; i < Math.min(count, 6); i++) {
                ctx.drawImage(img, x - 31.25, y + (i * dy) - 31.25, 62.5, 62.5);
            }

            if (count > 6) {
                const lastCheckerY = y + (5 * dy);
                ctx.fillText(`${count}`, x + 40, lastCheckerY + 5);
            }
        }

        const barX = 400;
        const barY = (player === 'second') ? 220 : 520;
        const barDy = (player === 'second') ? 55 : -55;
        if (positions.bar && positions.bar !== 0) {
            let y = barY;
            for (let i = 0; i < Math.min(Math.abs(positions.bar), 6); i++) {
                ctx.drawImage(img, barX - 31.25, y + (i * barDy) - 31.25, 62.5, 62.5);
            }
            if (Math.abs(positions.bar) > 6) {
                const lastCheckerY = y + (5 * barDy);
                ctx.fillText(`(${Math.abs(positions.bar)})`, barX + 30, lastCheckerY + 5);
            }
        }
    }

    function getDy(point) {
        return (point > 12) ? 55 : -55;
    }

    function drawBoard() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(boardImg, 0, 0, canvas.width, canvas.height);

        drawCheckers('first', whiteChecker, positions.first, 'first');
        drawCheckers('second', blackChecker, positions.second, 'second');
    }

    function getTotalCheckers(pos) {
        let total = 0;
        for (let key in pos) {
            total += pos[key];
        }
        return total;
    }

    function updateBoard() {
        // Update positions from dropdowns
        const color = document.querySelector('input[name="checkerColor"]:checked').value;
        const targetPositions = color === 'white' ? positions.first : positions.second;
        const otherPositions = color === 'white' ? positions.second : positions.first;

        for (let point = 1; point <= 24; point++) {
            const select = document.getElementById(`point-${point}`);
            const count = parseInt(select.value);
            const oldCount = targetPositions[point.toString()] || 0;

            if (count > 0) {
                const newTotal = getTotalCheckers(targetPositions) - oldCount + count;
                if (newTotal > 15) {
                    alert('Максимум 15 шашек на цвет!');
                    select.value = oldCount;
                    continue;
                }
                targetPositions[point.toString()] = count;
            } else {
                delete targetPositions[point.toString()];
            }
        }
        drawBoard();
        updateSelectOptions(color);
        updateBarSelects();
        updateOffSelects();
    }

    // Load images and draw
    let imagesLoaded = 0;
    const totalImages = 3;

    function imageLoaded() {
        imagesLoaded++;
        if (imagesLoaded === totalImages) {
            createDropdowns();
            drawBoard();
            document.querySelectorAll('input[name="checkerColor"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const newColor = radio.value;
                    updateSelectOptions(newColor);
                    // Update select values to match positions for new color
                    for (let point = 1; point <= 24; point++) {
                        const select = document.getElementById(`point-${point}`);
                        const targetPositions = newColor === 'white' ? positions.first : positions.second;
                        select.value = targetPositions[point.toString()] || 0;
                    }
                    updateBarSelects();
                });
            });
            document.getElementById('white-bar-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.first.bar = count;
                } else {
                    delete positions.first.bar;
                }
                drawBoard();
                updateSelectOptions('white');
                updateBarSelects();
            });
            document.getElementById('black-bar-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.second.bar = count;
                } else {
                    delete positions.second.bar;
                }
                drawBoard();
                updateSelectOptions('black');
                updateBarSelects();
            });
            document.getElementById('white-off-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.first.off = count;
                } else {
                    delete positions.first.off;
                }
                drawBoard();
                updateSelectOptions('white');
                updateOffSelects();
            });
            document.getElementById('black-off-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.second.off = count;
                } else {
                    delete positions.second.off;
                }
                drawBoard();
                updateSelectOptions('black');
                updateOffSelects();
            });
        }
    }

    boardImg.onload = imageLoaded;
    whiteChecker.onload = imageLoaded;
    blackChecker.onload = imageLoaded;

    document.getElementById('game-type-select').addEventListener('change', (e) => {
        const matchPanel = document.querySelector('.match-panel');
        if (e.target.value === 'матч') {
            matchPanel.style.display = 'flex';
        } else {
            matchPanel.style.display = 'none';
        }
    });

    window.addEventListener('resize', updateAllDropdownPositions);
</script>
</body>

</html>