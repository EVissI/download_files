<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backgammon Board Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background-color: #1a1a1a;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            width: 50%;
            box-sizing: border-box;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            width: 50%;
            gap: 1rem;
            align-items: center;
            box-sizing: border-box;
        }

        h1 {
            display: none;
        }

        .board-wrapper {
            position: relative;
            margin-top: 1.5rem;
            flex: 1;
        }

        canvas {
            border: 0.125rem solid #333;
            border-radius: 0.5rem;
            background-color: #2a2a2a;
            width: 99%;
            aspect-ratio: 1 / 1;
            display: block;
        }

        .dropdown {
            position: absolute;
            font-size: 0.8rem;
        }

        select {
            font-family: Arial, sans-serif;
            font-size: 0.8rem;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            padding: 0.125rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .nickname_inputs {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 50%;
        }

        .nickname_inputs div {
            display: flex;
            align-items: center;
            padding-left: 1rem;
            margin-bottom: 0.5rem;
        }

        .nickname_inputs label {
            color: white;
            margin-right: 0.625rem;
            font-size: 0.8rem;
            width: 5rem;
            text-align: left;
            flex-shrink: 0;
        }

        .nickname_inputs input {
            flex: 1;
            padding: 0.3125rem;
            font-size: 0.8rem;
            text-align: center;
            border: 1px solid #444;
            border-radius: 0.25rem;
            background-color: #2d2d2d;
            color: white;
        }

        .selectors-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-top: 1rem;
            padding-left: 1rem;
            margin: 1rem 0;
        }

        .game-panel {
            display: flex;
            flex-direction: row;
            width: 100%;
            gap: 0.5rem;
        }

        .cube_panel {
            display: flex;
            flex-direction: row;
            width: 100%;
            gap: 0.5rem;
        }

        .selectors-container {
            position: relative;
            min-height: 4.8rem;
            max-width: 60%;
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            padding-top: 2vh;
        }

        .game-type {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            margin: 0 auto;
            padding-top: 1.5rem;
        }

        .game-type label {
            color: white;
            font-size: 0.96rem;
            width: 100%;
            text-align: center;
        }

        .game-type select {
            font-family: Arial, sans-serif;
            font-size: 0.96rem;
            color: white;
            width: 6rem;
            height: 3rem;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            padding: 0.125rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        .checker-selector {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }



        .checker-selector label {
            color: white;
            font-size: 0.96rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bar-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: white;
        }

        .bar-selector .selectors {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .bar-selector .selectors div {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.1rem;
        }

        .bar-selector label {
            font-size: 0.96rem;
            width: 60px;
        }

        .bar-selector select {
            background-color: #2d2d2d;
            color: white;
            border: 1px solid #444;
            border-radius: 0.25rem;
            text-align: center;
        }


        .bar-label {
            color: white;
            font-size: 0.96rem;
            text-align: center;
        }

        .checker-label {
            color: white;
            font-size: 0.96rem;
            text-align: center;
            align-self: center;
        }

        .match-panel {
            display: flex;
            width: 100%;
            box-sizing: border-box;
            flex-direction: row;
            gap: 0.3rem;
            padding-left: 1rem;
        }

        .manigeym-panel {
            display: flex;
            width: 100%;
            box-sizing: border-box;
            justify-content: center;
        }

        .centered-options {
            display: flex;
            gap: 1rem;
        }

        .score-inputs {
            display: flex;
            gap: 0.3rem;
            flex-direction: column;
        }

        .score-inputs div {
            display: flex;
            align-items: center;
        }

        .score-inputs label {
            color: white;
            font-size: 0.8rem;
            width: 8.5rem;
            text-align: left;
            flex-shrink: 0;
        }

        .score-inputs input {
            text-align: center;
            border: 1px solid #444;
            border-radius: 0.25rem;
            background-color: #2d2d2d;
            color: white;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .score-inputs select {
            text-align: center;
            border: 1px solid #444;
            border-radius: 0.25rem;
            background-color: #2d2d2d;
            color: white;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }

        .left-panel2 {
            width: 50%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-top: 1rem;
        }

        .right-panel2 {
            width: 50%;
            display: flex;
            flex-direction: column;
            padding-top: 1rem;
            gap: 0.5rem;
            align-items: center;
        }

        .turn-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .turn-selector label {
            color: white;
            width: 3.8rem;
            font-size: 0.8rem;
        }

        .turn-selector select {
            width: 135px;
        }

        .score-inputs input::-webkit-outer-spin-button,
        .score-inputs input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .max-cube-options {
            display: flex;
            flex-direction: column;
        }

        .max-cube-options div {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .max-cube-options label {
            color: white;
            font-size: 0.8rem;
            text-align: left;
            flex-shrink: 0;
            width: 4rem;
        }

        .max-cube-options select {
            font-family: Arial, sans-serif;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        .crawford-options {
            display: flex;
            flex-direction: column;
        }

        .crawford-options div {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .crawford-options label {
            color: white;
            font-size: 0.8rem;
            text-align: left;
            flex-shrink: 0;
            width: 4rem;
        }

        .crawford-options select {
            font-family: Arial, sans-serif;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        .jacobi-options {
            display: flex;
            flex-direction: column;
        }

        .jacobi-options div {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .jacobi-options label {
            color: white;
            font-size: 0.8rem;
            text-align: left;
            flex-shrink: 0;
        }

        .jacobi-options select {
            font-family: Arial, sans-serif;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        .beaver-options {
            display: flex;
            flex-direction: column;
        }

        .beaver-options div {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .beaver-options label {
            color: white;
            font-size: 0.8rem;
            text-align: left;
            flex-shrink: 0;
        }

        .beaver-options select {
            font-family: Arial, sans-serif;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        .selector-size {
            width: 60px;
            height: 30px;
            font-size: 0.8rem;
            padding: 0.3125rem;
        }


        .max-cube-options_money {
            display: flex;
            flex-direction: column;
        }

        .max-cube-options_money div {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .max-cube-options_money label {
            color: white;
            font-size: 0.8rem;
            text-align: left;
            flex-shrink: 0;
        }

        .max-cube-options_money select {
            font-family: Arial, sans-serif;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        .cube-value-options {
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        .cube-value-options div {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .cube-value-options label {
            color: white;
            font-size: 0.8rem;
            text-align: left;
            flex-shrink: 0;
            padding-left: 0.8rem;
            width: 5.5rem;
        }

        .cube-value-options select {
            font-family: Arial, sans-serif;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.25rem;
            -webkit-appearance: none;
            appearance: none;
            text-align: center;
        }

        .cube-owner-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .cube-owner-selector label {
            color: white;
            width: 3.8rem;
            font-size: 0.8rem;
        }

        .cube-owner-selector select {
            width: 120px;
        }

        .dice-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .dice-selector label {
            color: white;
            font-size: 0.8rem;
        }

        .dice-selector select {
            width: 48px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            justify-content: left;
        }

        .action-buttons button {
            padding: 0.6rem 1.2rem;
            font-size: 0.8rem;
            border-radius: 0.3rem;
            margin: 0;
            flex-shrink: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Backgammon Board Editor</h1>
        <div class="nickname_inputs">
            <div>
                <label for="white-input">Белые:</label>
                <input type="text" id="white-input" value="nick_1">
            </div>
            <div>
                <label for="black-input">Черные:</label>
                <input type="text" id="black-input" value="nick_2">
            </div>
        </div>
        <div class="board-wrapper">
            <canvas id="boardCanvas" width="800" height="800"></canvas>
        </div>
        <div class="selectors-wrapper">
            <div class="selectors-container">
                <div class="checker-selector">
                    <div class="checker-label">Шашки:</div>
                    <label><input type="radio" name="checkerColor" value="white" checked> Белые</label>
                    <label><input type="radio" name="checkerColor" value="black"> Черные</label>
                </div>
                <div class="bar-selector">
                    <div class="bar-label">На баре:</div>
                    <div class="selectors">
                        <div>
                            <label for="white-bar-select">Белый:</label>
                            <select id="white-bar-select" class="selector-size">
                                <option value="0">0</option>
                            </select>
                        </div>
                        <div>
                            <label for="black-bar-select">Черный:</label>
                            <select id="black-bar-select" class="selector-size">
                                <option value="0">0</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="game-type">
                <label for="game-type-select">Тип игры</label>
                <select id="game-type-select">
                    <option value="манигейм">манигейм</option>
                    <option value="матч">матч</option>
                </select>
            </div>
        </div>
        <div class="game-panel">
            <div class="match-panel" style="display: none;">
                <div class='left-panel'>
                    <div class="score-inputs">
                        <div>
                            <label for="lower-score">Очки нижнего игрока:</label>
                            <select id="lower-score" class="selector-size">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <div>
                            <label for="upper-score">Очки верхнего игрока:</label>
                            <select id="upper-score" class="selector-size">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <div>
                            <label for="upper-score">Длина матча:</label>
                            <input type="number" id="match_lenght" class="selector-size" min="0" , value="0">
                        </div>
                    </div>
                </div>
                <div class='right-panel'>
                    <div class="crawford-options">
                        <div>
                            <label for="crawford-select">Кроуфорд</label>
                            <select id="crawford-select" class="selector-size">
                                <option value="0" selected>0</option>
                                <option value="1">1</option>
                            </select>
                        </div>
                    </div>
                    <div class="max-cube-options">
                        <div>
                            <label for="max-cube-select">Макс куб</label>
                            <select id="max-cube-select" class="selector-size">
                                <option value="2">2</option>
                                <option value="4">4</option>
                                <option value="8" selected>8</option>
                                <option value="16">16</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="manigeym-panel">
            <div class="centered-options">
                <div class="jacobi-options">
                    <div>
                        <label for="jacobi-select">Якоби</label>
                        <select id="jacobi-select" class="selector-size">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                        </select>
                    </div>
                </div>
                <div class="beaver-options">
                    <div>
                        <label for="beaver-select">Бивер</label>
                        <select id="beaver-select" class="selector-size">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                        </select>
                    </div>
                </div>
                <div class="max-cube-options_money">
                    <div>
                        <label for="max-cube-select-m">Макс куб</label>
                        <select id="max-cube-select-m" class="selector-size">
                            <option value="2">2</option>
                            <option value="4">4</option>
                            <option value="8" selected>8</option>
                            <option value="16">16</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class='cube_panel'>
        <div class="left-panel2">
            <div class="turn-selector">
                <label for="turn-select">Чей ход?</label>
                <select id="turn-select" class="selector-size"></select>
            </div>
            <div class="action-buttons">
                <button id="clear-button">Очистить</button>
                <button id="init-button">Начальная позиция</button>
                <button id="show-button">Показать</button>
            </div>
        </div>
        <div class="right-panel2">
            <div class="cube-value-options">
                <div>
                    <label for="cube-value-select">Значение куба</label>
                    <select id="cube-value-select" class="selector-size">
                        <option value="0">0</option>
                        <option value="2">2</option>
                        <option value="4">4</option>
                        <option value="8">8</option>
                        <option value="16">16</option>
                        <option value="32">32</option>
                        <option value="64">64</option>
                    </select>
                </div>
            </div>
            <div class="cube-owner-selector">
                <label for="cube-owner-select">Чей куб?</label>
                <select id="cube-owner-select" class="selector-size"></select>
            </div>
            <div class="dice-selector">
                <label>На кубиках:</label>
                <select id="dice1-select" class="selector-size">
                    <option value="0" selected>0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
                <select id="dice2-select" class="selector-size">
                    <option value="0" selected>0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
        </div>
    </div>
</body>

<script>
    let positions = {
        first: {},
        second: {}
    };

    const canvas = document.getElementById('boardCanvas');
    const ctx = canvas.getContext('2d');
    const boardWrapper = document.querySelector('.board-wrapper');

    // Load images
    const boardImg = new Image();
    boardImg.src = '/static/board.png';
    const whiteChecker = new Image();
    whiteChecker.src = '/static/white_checker.png';
    const blackChecker = new Image();
    blackChecker.src = '/static/black_checker.png';

    // Load dice images
    const Dice1w = new Image();
    Dice1w.src = '/static/1w.png?t=' + Date.now();
    const Dice2w = new Image();
    Dice2w.src = '/static/2w.png?t=' + Date.now();
    const Dice3w = new Image();
    Dice3w.src = '/static/3w.png?t=' + Date.now();
    const Dice4w = new Image();
    Dice4w.src = '/static/4w.png?t=' + Date.now();
    const Dice5w = new Image();
    Dice5w.src = '/static/5w.png?t=' + Date.now();
    const Dice6w = new Image();
    Dice6w.src = '/static/6w.png?t=' + Date.now();

    const Dice1b = new Image();
    Dice1b.src = '/static/1b.png?t=' + Date.now();
    const Dice2b = new Image();
    Dice2b.src = '/static/2b.png?t=' + Date.now();
    const Dice3b = new Image();
    Dice3b.src = '/static/3b.png?t=' + Date.now();
    const Dice4b = new Image();
    Dice4b.src = '/static/4b.png?t=' + Date.now();
    const Dice5b = new Image();
    Dice5b.src = '/static/5b.png?t=' + Date.now();
    const Dice6b = new Image();
    Dice6b.src = '/static/6b.png?t=' + Date.now();

    // Load cube images
    const Double2 = new Image();
    Double2.src = '/static/Double2.png?t=' + Date.now();
    const Double4 = new Image();
    Double4.src = '/static/Double4.png?t=' + Date.now();
    const Double8 = new Image();
    Double8.src = '/static/Double8.png?t=' + Date.now();
    const Double16 = new Image();
    Double16.src = '/static/Double16.png?t=' + Date.now();
    const Double32 = new Image();
    Double32.src = '/static/Double32.png?t=' + Date.now();
    const Double64 = new Image();
    Double64.src = '/static/Double64.png?t=' + Date.now();

    const diceImages = {
        white: {
            1: Dice1w,
            2: Dice2w,
            3: Dice3w,
            4: Dice4w,
            5: Dice5w,
            6: Dice6w
        },
        black: {
            1: Dice1b,
            2: Dice2b,
            3: Dice3b,
            4: Dice4b,
            5: Dice5b,
            6: Dice6b
        }
    };

    const cubeImages = {
        2: Double2,
        4: Double4,
        8: Double8,
        16: Double16,
        32: Double32,
        64: Double64
    };

    function getX(point) {
        if (point >= 13 && point <= 18) {
            const baseX = 50 + (point - 13) * 60;
            return baseX - (point === 13 ? 8 : 0);
        } else if (point >= 19 && point <= 24) {
            return 450 + (point - 19) * 60;
        } else if (point >= 7 && point <= 12) {
            const baseX = 50 + (12 - point) * 60;
            return baseX - (point === 12 ? 4 : 0);
        } else if (point >= 1 && point <= 6) {
            return 450 + (6 - point) * 60;
        }
        return 0;
    }

    function getBaseY(point) {
        return (point > 12) ? 70 : 690;
    }

    function updateSelectOptions(color) {
        const targetPositions = color === 'white' ? positions.first : positions.second;
        const otherPositions = color === 'white' ? positions.second : positions.first;
        const totalCheckers = getTotalCheckers(targetPositions);
        for (let point = 1; point <= 24; point++) {
            const select = document.getElementById(`point-${point}`);
            if (!select) continue;
            const currentOnPoint = targetPositions[point.toString()] || 0;
            const occupiedByOther = otherPositions[point.toString()] > 0;
            const baseMax = occupiedByOther ? 0 : 15;
            const maxForThis = Math.min(baseMax, 15 - (totalCheckers - currentOnPoint));
            select.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                select.appendChild(option);
            }
            select.value = currentOnPoint;
        }
    }

    function updateBarSelects() {
        const whiteBarSelect = document.getElementById('white-bar-select');
        const blackBarSelect = document.getElementById('black-bar-select');
        if (whiteBarSelect) {
            const currentBar = parseInt(whiteBarSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.first);
            const maxForThis = 15 - (totalCheckers - currentBar);
            whiteBarSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                whiteBarSelect.appendChild(option);
            }
            whiteBarSelect.value = currentBar;
        }
        if (blackBarSelect) {
            const currentBar = parseInt(blackBarSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.second);
            const maxForThis = 15 - (totalCheckers - currentBar);
            blackBarSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                blackBarSelect.appendChild(option);
            }
            blackBarSelect.value = currentBar;
        }
    }

    function updateOffSelects() {
        const whiteOffSelect = document.getElementById('white-off-select');
        const blackOffSelect = document.getElementById('black-off-select');
        if (whiteOffSelect) {
            const currentOff = parseInt(whiteOffSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.first);
            const maxForThis = 15 - (totalCheckers - currentOff);
            whiteOffSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                whiteOffSelect.appendChild(option);
            }
            whiteOffSelect.value = currentOff;
        }
        if (blackOffSelect) {
            const currentOff = parseInt(blackOffSelect.value) || 0;
            const totalCheckers = getTotalCheckers(positions.second);
            const maxForThis = 15 - (totalCheckers - currentOff);
            blackOffSelect.innerHTML = '';
            for (let i = 0; i <= maxForThis; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                blackOffSelect.appendChild(option);
            }
            blackOffSelect.value = currentOff;
        }
    }

    function createDropdowns() {
        const scale = canvas.offsetWidth / 800;
        for (let point = 1; point <= 24; point++) {
            const select = document.createElement('select');
            select.id = `point-${point}`;
            select.className = 'dropdown';
            select.value = 0;

            updateDropdownPosition(select, point, scale);

            select.addEventListener('change', updateBoard);

            boardWrapper.appendChild(select);
        }
        updateSelectOptions('white');
        updateBarSelects();
        updateOffSelects();
        updateOffSelects();
    }

    function updateDropdownPosition(select, point, scale) {
        const x = (getX(point) - (point > 12 ? 25 : 25)) * scale;
        let y_text;
        if (point > 12) {
            y_text = 20;
        } else {
            y_text = 750;
        }
        const offset = point > 12 ? -70 : 43;
        const y = (y_text + offset) * scale;
        select.style.left = x + 'px';
        select.style.top = y + 'px';
        select.style.width = (55 * scale) + 'px';
        select.style.height = (55 * scale) + 'px';
        select.style.fontSize = (26 * scale) + 'px';
    }

    function updateAllDropdownPositions() {
        const scale = canvas.offsetWidth / 800;
        for (let point = 1; point <= 24; point++) {
            const select = document.getElementById(`point-${point}`);
            if (select) {
                updateDropdownPosition(select, point, scale);
            }
        }
    }

    function drawCheckers(player, img, positions, currentPlayer) {
        ctx.font = 'bold 1.875rem Arial';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (player === currentPlayer) {
            for (let point = 1; point <= 24; point++) {
                const x = getX(point);
                let y = getBaseY(point);
                const dy = getDy(point);

                let displayPoint = point;
                ctx.fillText(displayPoint, x, point > 12 ? y - 50 : y + 60);
            }
        }

        for (let pointStr in positions) {
            if (pointStr === 'bar' || pointStr === 'off') continue;
            const point = parseInt(pointStr);
            let count = positions[pointStr];
            const x = getX(point);
            let y = getBaseY(point);
            const dy = getDy(point);

            for (let i = 0; i < Math.min(count, 6); i++) {
                ctx.drawImage(img, x - 31.25, y + (i * dy) - 31.25, 62.5, 62.5);
            }

            if (count > 6) {
                const lastCheckerY = y + (5 * dy);
                ctx.fillText(`${count}`, x + 40, lastCheckerY + 5);
            }
        }

        const barX = 400;
        const barY = (player === 'second') ? 220 : 520;
        const barDy = (player === 'second') ? 55 : -55;
        if (positions.bar && positions.bar !== 0) {
            let y = barY;
            for (let i = 0; i < Math.min(Math.abs(positions.bar), 6); i++) {
                ctx.drawImage(img, barX - 31.25, y + (i * barDy) - 31.25, 62.5, 62.5);
            }
            if (Math.abs(positions.bar) > 6) {
                const lastCheckerY = y + (5 * barDy);
                ctx.fillText(`(${Math.abs(positions.bar)})`, barX + 30, lastCheckerY + 5);
            }
        }
    }

    function getDy(point) {
        return (point > 12) ? 55 : -55;
    }

    function drawBoard() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(boardImg, 0, 0, canvas.width, canvas.height);

        drawCheckers('first', whiteChecker, positions.first, 'first');
        drawCheckers('second', blackChecker, positions.second, 'second');

        // Draw dice
        const d1 = parseInt(document.getElementById('dice1-select').value);
        const d2 = parseInt(document.getElementById('dice2-select').value);
        const turn = document.getElementById('turn-select').value; // 'white' or 'black'

        if (d1 > 0 || d2 > 0) {
            const diceY = 350;
            let diceX1, diceX2;
            let diceSet;
            if (turn === 'white') {
                diceX1 = 530;
                diceX2 = 620;
                diceSet = diceImages.white;
            } else {
                diceX1 = 130;
                diceX2 = 220;
                diceSet = diceImages.black;
            }
            if (diceSet[d1]) ctx.drawImage(diceSet[d1], diceX1, diceY, 60, 60);
            if (diceSet[d2]) ctx.drawImage(diceSet[d2], diceX2, diceY, 60, 60);
        }

        // Draw cube
        const cubeValue = parseInt(document.getElementById('cube-value-select').value);
        const cubeOwner = document.getElementById('cube-owner-select').value;

        if (cubeValue > 0) {
            const img = cubeImages[cubeValue];
            if (img) {
                let cubeY = 350;
                if (cubeOwner === 'white') {
                    cubeY = 600;
                } else if (cubeOwner === 'black') {
                    cubeY = 100;
                }
                ctx.drawImage(img, 375, cubeY, 50, 50);
            }
        }
    }

    function getTotalCheckers(pos) {
        let total = 0;
        for (let key in pos) {
            total += pos[key];
        }
        return total;
    }

    function updateBoard() {
        // Update positions from dropdowns
        const color = document.querySelector('input[name="checkerColor"]:checked').value;
        const targetPositions = color === 'white' ? positions.first : positions.second;
        const otherPositions = color === 'white' ? positions.second : positions.first;

        for (let point = 1; point <= 24; point++) {
            const select = document.getElementById(`point-${point}`);
            const count = parseInt(select.value);
            const oldCount = targetPositions[point.toString()] || 0;

            if (count > 0) {
                const newTotal = getTotalCheckers(targetPositions) - oldCount + count;
                if (newTotal > 15) {
                    alert('Максимум 15 шашек на цвет!');
                    select.value = oldCount;
                    continue;
                }
                targetPositions[point.toString()] = count;
            } else {
                delete targetPositions[point.toString()];
            }
        }
        drawBoard();
        updateSelectOptions(color);
        updateBarSelects();
        updateOffSelects();
    }

    function updateTurnSelect() {
        const whiteNick = document.getElementById('white-input').value || 'Белые';
        const blackNick = document.getElementById('black-input').value || 'Черные';
        const turnSelect = document.getElementById('turn-select');
        turnSelect.innerHTML = '';
        const optionWhite = document.createElement('option');
        optionWhite.value = 'white';
        optionWhite.textContent = whiteNick;
        turnSelect.appendChild(optionWhite);
        const optionBlack = document.createElement('option');
        optionBlack.value = 'black';
        optionBlack.textContent = blackNick;
        turnSelect.appendChild(optionBlack);
    }

    function updateCubeOwnerSelect() {
        const whiteNick = document.getElementById('white-input').value || 'Белые';
        const blackNick = document.getElementById('black-input').value || 'Черные';
        const cubeOwnerSelect = document.getElementById('cube-owner-select');
        cubeOwnerSelect.innerHTML = '';
        const optionWhite = document.createElement('option');
        optionWhite.value = 'white';
        optionWhite.textContent = whiteNick;
        cubeOwnerSelect.appendChild(optionWhite);
        const optionBlack = document.createElement('option');
        optionBlack.value = 'black';
        optionBlack.textContent = blackNick;
        cubeOwnerSelect.appendChild(optionBlack);
    }

    // Load images and draw
    let imagesLoaded = 0;
    const totalImages = 21; // 3 checkers + 12 dice + 6 cubes

    function imageLoaded() {
        imagesLoaded++;
        if (imagesLoaded === totalImages) {
            createDropdowns();
            drawBoard();
            updateTurnSelect();
            updateCubeOwnerSelect();
            document.getElementById('white-input').addEventListener('input', updateTurnSelect);
            document.getElementById('white-input').addEventListener('input', updateCubeOwnerSelect);
            document.getElementById('white-input').addEventListener('input', drawBoard);
            document.getElementById('black-input').addEventListener('input', updateTurnSelect);
            document.getElementById('black-input').addEventListener('input', updateCubeOwnerSelect);
            document.getElementById('black-input').addEventListener('input', drawBoard);
            document.getElementById('lower-score').addEventListener('change', drawBoard);
            document.getElementById('upper-score').addEventListener('change', drawBoard);
            document.getElementById('match_lenght').addEventListener('input', drawBoard);
            document.querySelectorAll('input[name="checkerColor"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const newColor = radio.value;
                    updateSelectOptions(newColor);
                    for (let point = 1; point <= 24; point++) {
                        const select = document.getElementById(`point-${point}`);
                        const targetPositions = newColor === 'white' ? positions.first : positions.second;
                        select.value = targetPositions[point.toString()] || 0;
                    }
                    updateBarSelects();
                    drawBoard();
                });
            });
            document.getElementById('white-bar-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.first.bar = count;
                } else {
                    delete positions.first.bar;
                }
                drawBoard();
                updateSelectOptions('white');
                updateBarSelects();
            });
            document.getElementById('black-bar-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.second.bar = count;
                } else {
                    delete positions.second.bar;
                }
                drawBoard();
                updateSelectOptions('black');
                updateBarSelects();
            });
            document.getElementById('white-off-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.first.off = count;
                } else {
                    delete positions.first.off;
                }
                drawBoard();
                updateSelectOptions('white');
                updateOffSelects();
            });
            document.getElementById('black-off-select').addEventListener('change', (e) => {
                const count = parseInt(e.target.value);
                if (count > 0) {
                    positions.second.off = count;
                } else {
                    delete positions.second.off;
                }
                drawBoard();
                updateSelectOptions('black');
                updateOffSelects();
            });
        }
    }

    boardImg.onload = imageLoaded;
    whiteChecker.onload = imageLoaded;
    blackChecker.onload = imageLoaded;
    Dice1w.onload = imageLoaded;
    Dice2w.onload = imageLoaded;
    Dice3w.onload = imageLoaded;
    Dice4w.onload = imageLoaded;
    Dice5w.onload = imageLoaded;
    Dice6w.onload = imageLoaded;
    Dice1b.onload = imageLoaded;
    Dice2b.onload = imageLoaded;
    Dice3b.onload = imageLoaded;
    Dice4b.onload = imageLoaded;
    Dice5b.onload = imageLoaded;
    Dice6b.onload = imageLoaded;
    Double2.onload = imageLoaded;
    Double4.onload = imageLoaded;
    Double8.onload = imageLoaded;
    Double16.onload = imageLoaded;
    Double32.onload = imageLoaded;
    Double64.onload = imageLoaded;

    document.getElementById('game-type-select').addEventListener('change', (e) => {
        const matchPanel = document.querySelector('.match-panel');
        const manigeymPanel = document.querySelector('.manigeym-panel');
        if (e.target.value === 'матч') {
            matchPanel.style.display = 'flex';
            manigeymPanel.style.display = 'none';
        } else if (e.target.value === 'манигейм') {
            matchPanel.style.display = 'none';
            manigeymPanel.style.display = 'flex';
        } else {
            matchPanel.style.display = 'none';
            manigeymPanel.style.display = 'none';
        }
    });
    function generateXGID() {
        let xgid = "";
        const whiteBar = positions.first.bar || 0;
        if (whiteBar === 0) {
            xgid += "-";
        } else if (whiteBar <= 15) {
            xgid += String.fromCharCode(64 + whiteBar);
        }
        for (let point = 1; point <= 24; point++) {
            const whiteCount = positions.first[point] || 0;
            const blackCount = positions.second[point] || 0;

            if (whiteCount > 0) {
                if (whiteCount <= 15) {
                    xgid += String.fromCharCode(64 + whiteCount);
                }
            } else if (blackCount > 0) {
                if (blackCount <= 15) {
                    xgid += String.fromCharCode(96 + blackCount);
                }
            } else {
                xgid += "-";
            }
        }
        const blackBar = positions.second.bar || 0;
        if (blackBar === 0) {
            xgid += "-";
        } else if (blackBar <= 15) {
            xgid += String.fromCharCode(96 + blackBar);
        }
        return xgid;
    }
    // Add event listeners for elements that affect board drawing
    document.getElementById('turn-select').addEventListener('change', drawBoard);
    document.getElementById('cube-value-select').addEventListener('change', drawBoard);
    document.getElementById('cube-owner-select').addEventListener('change', drawBoard);
    document.getElementById('dice1-select').addEventListener('change', drawBoard);
    document.getElementById('dice2-select').addEventListener('change', drawBoard);
    document.getElementById('show-button').addEventListener('click', () => {
        const xgid = generateXGID();


        if (xgid.length !== 26) {
            alert(`Ошибка: XGID строка должна содержать 26 символов, а содержит ${xgid.length}\nXGID: ${xgid}`);
        } else {
            alert(`XGID: ${xgid}\n\nДлина строки: ${xgid.length} символов (корректно)`);
        }
    });

    // Clear button logic
    document.getElementById('clear-button').addEventListener('click', () => {
        positions = {
            first: {},
            second: {}
        };

        document.getElementById('white-input').value = 'nick_1';
        document.getElementById('black-input').value = 'nick_2';
        document.querySelector('input[name="checkerColor"][value="white"]').checked = true;
        document.getElementById('white-bar-select').value = '0';
        document.getElementById('black-bar-select').value = '0';
        document.getElementById('game-type-select').value = 'манигейм';
        document.getElementById('lower-score').value = '0';
        document.getElementById('upper-score').value = '0';
        document.getElementById('match_lenght').value = '0';
        document.getElementById('crawford-select').value = '0';
        document.getElementById('max-cube-select').value = '8';
        document.getElementById('jacobi-select').value = '0';
        document.getElementById('beaver-select').value = '0';
        document.getElementById('max-cube-select-m').value = '8';
        document.getElementById('cube-value-select').value = '0';
        document.getElementById('dice1-select').value = '0';
        document.getElementById('dice2-select').value = '0';

        updateTurnSelect();
        updateCubeOwnerSelect();
        updateSelectOptions('white');
        updateBarSelects();
        updateOffSelects();

        for (let point = 1; point <= 24; point++) {
            document.getElementById(`point-${point}`).value = '0';
        }

        const matchPanel = document.querySelector('.match-panel');
        const manigeymPanel = document.querySelector('.manigeym-panel');
        matchPanel.style.display = 'none';
        manigeymPanel.style.display = 'flex';

        drawBoard();
    });

    // Init button logic
    document.getElementById('init-button').addEventListener('click', () => {
        positions.first = { 6: 5, 8: 3, 13: 5, 24: 2 };
        positions.second = { 1: 2, 12: 5, 17: 3, 19: 5 };

        document.querySelector('input[name="checkerColor"][value="white"]').checked = true;
        document.getElementById('white-bar-select').value = '0';
        document.getElementById('black-bar-select').value = '0';

        updateSelectOptions('white');
        updateBarSelects();
        updateOffSelects();

        for (let point = 1; point <= 24; point++) {
            const select = document.getElementById(`point-${point}`);
            select.value = positions.first[point.toString()] || 0;
        }

        drawBoard();
    });

    window.addEventListener('resize', updateAllDropdownPositions);
</script>
</body>

</html>