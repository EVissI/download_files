<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backgammon Game Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background-color: #1a1a1a;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1 {
            display: none; /* Hide the main title */
        }

        canvas {
            border: 2px solid #333;
            border-radius: 8px;
            background-color: #2a2a2a;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }

        .game-info {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #444;
        }

        .hints-table {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #444;
            overflow-x: auto;
        }

        table {
            margin: 0 auto;
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #555;
            padding: 12px;
            text-align: left;
            color: white;
        }

        th {
            background-color: #444;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #2a2a2a;
        }

        tr:hover {
            background-color: #3a3a2a;
        }

        #controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .turn-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #turnLabel {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin: 0;
            min-width: 80px;
            text-align: center;
        }

        .info-text {
            color: #ccc;
            margin: 10px 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            canvas {
                width: 100%;
                height: 100%;
            }

            #controls {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: center;
                width: 100%;
            }

            #turnLabel {
                margin: 10px 0;
                font-size: 16px;
            }

            button {
                width: 60px;
                padding: 10px 20px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px 6px;
            }

            .container {
                padding: 0 10px;
            }

            .game-info, .hints-table {
                padding: 15px;
                margin: 15px 0;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            canvas {
                width: 100%;
                height: 100%;
            }

            button {
                width: 60px;
                padding: 8px 16px;
                font-size: 14px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 6px 4px;
            }
        }

        /* Loading indicator */
        .loading {
            color: #007bff;
            font-style: italic;
        }

        /* Error messages */
        .error {
            color: #dc3545;
            background-color: #2d1b1b;
            border: 1px solid #dc3545;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Get game_id from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('game_id') || 'default';
    </script>
</head>
<body>
    <div class="container">
        <h1>Backgammon Game Analysis</h1>
        <canvas id="boardCanvas" width="800" height="800"></canvas>

        <div id="controls">
            <button onclick="prevTurn()" id="prevBtn">←</button>
            <span id="turnLabel">Ход 0</span>
            <button onclick="nextTurn()" id="nextBtn">→</button>
        </div>
        <div class="hints-table">
            <div id="hints"></div>
        </div>

        <div class="game-info">
            <div id="info" class="info-text"></div>
        </div>
    </div>

    <script>
        // Telegram Web App initialization
        if (window.Telegram) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // Load JSON data from API
        let data = [];
        const infoDiv = document.getElementById('info');
        infoDiv.innerHTML = '<div class="loading">Loading game data...</div>';

        fetch(`/api/analysis/${gameId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(json => {
                data = json.filter(item => item.turn !== undefined); // Filter to only turns, exclude final win if needed
                if (data.length > 0) {
                    render(0);
                    infoDiv.innerHTML = ''; // Clear loading message
                } else {
                    infoDiv.innerHTML = '<div class="error">No game data found for this game ID.</div>';
                }
            })
            .catch(error => {
                console.error('Error loading JSON:', error);
                infoDiv.innerHTML = '<div class="error">Error loading game data. Please check the game ID and try again.</div>';
            });

        let current = 0;
        const canvas = document.getElementById('boardCanvas');
        const ctx = canvas.getContext('2d');

        // Load images (assume they are in the static directory)
        const boardImg = new Image();
        boardImg.src = '/static/board.png';

        const blackImg = new Image();
        blackImg.src = '/static/black_checker.png';

        const whiteImg = new Image();
        whiteImg.src = '/static/white_checker.png';

        let imagesLoaded = 0;
        const checkImagesLoaded = () => {
            imagesLoaded++;
            if (imagesLoaded === 3 && data.length > 0) {
                render(current);
            }
        };

        boardImg.onload = checkImagesLoaded;
        blackImg.onload = checkImagesLoaded;
        whiteImg.onload = checkImagesLoaded;

        // Function to get X coordinate for a point (1-24), adjusted for right board
        function getX(point) {
            if (point >= 13 && point <= 18) {
                return 50 + (point - 13) * 60; 
            } else if (point >= 19 && point <= 24) {
                return 450 + (point - 19) * 60; 
            } else if (point >= 7 && point <= 12) {
                return 50 + (12 - point) * 60; 
            } else if (point >= 1 && point <= 6) {
                return 450 + (6 - point) * 60; 
            }
            return 0;
        }

        // Base Y and direction for stacking with doubled height
        function getBaseY(point) {
            return (point > 12) ? 70 : 690; 
        }

        function getDy(point) {
            return (point > 12) ? 45 : -45; 
        }

        // Draw checkers for a player with padding
        function drawCheckers(player, img) {
            const positions = data[current].positions[player];
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = '#ffffff';

            for (let pointStr in positions) {
                if (pointStr === 'bar' || pointStr === 'off') continue;
                const point = parseInt(pointStr);
                let count = positions[pointStr];
                const x = getX(point);
                let y = getBaseY(point);
                const dy = getDy(point);

                // Draw up to 4 checkers with padding
                for (let i = 0; i < Math.min(count, 4); i++) {
                    ctx.drawImage(img, x - 25, y + (i * dy) - 25, 50, 50);
                }

                // If more than 4, draw text with count to the right, closer to the last checker
                if (count > 4) {
                    const lastCheckerY = y + (3 * dy); // Position near the last checker (4th one)
                    ctx.fillText(`(${count})`, x + 20, lastCheckerY + 5); // Adjusted to right side, closer to last checker
                }
            }

            // Bar and Off as text with new format (on new line below)
            const barX = 410; // Middle bar
            const barY = (player === 'black') ? 100 : 700; 
            if (positions.bar > 0) {
                ctx.fillText('Bar:', barX - 20, barY);
                ctx.fillText(`${positions.bar}`, barX - 20, barY + 40); 
            }

            const offX = (player === 'black') ? 20 : 760;
            const offY = 400; 
            if (positions.off > 0) {
                ctx.fillText('Off:', offX, offY);
                ctx.fillText(`${positions.off}`, offX, offY + 40);
            }
        }

        // Render the current turn
        function render(turn) {
            current = turn;
            document.getElementById('turnLabel').innerText = `Ход ${data[turn].turn || 'End'}`;

            // Draw board
            ctx.clearRect(0, 0, 800, 800); // Updated height to 800
            ctx.drawImage(boardImg, 0, 0, 800, 800); // Updated height to 800

            // Draw checkers
            drawCheckers('red', whiteImg); // Red uses white checkers
            drawCheckers('black', blackImg);

            // Info (player, dice, etc.)
            const item = data[turn];
            let info = `<strong>Игрок:</strong> ${item.player} (${item.player_name || 'Unknown'})<br>`;
            if (item.dice) info += `<strong>Кости:</strong> ${item.dice.join(', ')}<br>`;
            if (item.moves) info += `<strong>Ходы:</strong> ${item.moves.map(m => `${m.from}/${m.to}${m.hit ? '*' : ''}`).join(' ')}<br>`;
            if (item.gnu_move) info += `<strong>Лучший ход:</strong> ${item.gnu_move}<br>`;
            if (item.is_best_move !== undefined) {
                info += `<strong>Лучший ли ход?:</strong> ${item.is_best_move ? 'Да' : 'Нет'}`;
            }
            document.getElementById('info').innerHTML = info;

            // Hints table
            let tableHtml = '<table><tr><th>Ход</th><th>Вероятности</th><th>Ошибка</th></tr>';
            (item.hints || []).forEach(hint => {
                if (hint.probs && hint.probs.length >= 2) {
                    const prob1 = hint.probs[0] ? hint.probs[0].toFixed(3) : '-';
                    const prob2 = hint.probs[1] ? hint.probs[1].toFixed(3) : '-';
                    const eq = hint.eq ? hint.eq.toFixed(3) : '-';
                    tableHtml += `<tr><td>${hint.move || '-'}</td><td>${prob1} ${prob2}</td><td>${eq}</td></tr>`;
                }
            });
            tableHtml += '</table>';
            document.getElementById('hints').innerHTML = tableHtml;
        }

        function prevTurn() {
            if (current > 0) {
                render(current - 1);
                updateButtons();
            }
        }

        function nextTurn() {
            if (current < data.length - 1) {
                render(current + 1);
                updateButtons();
            }
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = current <= 0;
            nextBtn.disabled = current >= data.length - 1;
        }
    </script>
</body>
</html>