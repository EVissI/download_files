<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backgammon Game Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background-color: #1a1a1a;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1 {
            display: none; 
        }

        canvas {
            border: 2px solid #333;
            border-radius: 8px;
            background-color: #2a2a2a;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }

        .game-info {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #444;
        }

        .hints-table {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #444;
            overflow-x: auto;
        }

        table {
            margin: 0 auto;
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #555;
            padding: 20px 30px;
            text-align: left;
            color: white;
            word-spacing: 16px;
        }

        th {
            background-color: #444;
            font-weight: bold;
            text-align: center;
        }

        tr:nth-child(even) {
            background-color: #2a2a2a;
        }

        tr:hover {
            background-color: #3a3a3a;
        }

        .hint-best {
            background-color: #2e7d32 !important;
        }

        .hint-good {
            background-color: #fbc02d !important;
        }
        .hint-good td {
            color: #1a1a1a !important;
        }
        .hint-poor {
            background-color: #d32f2f !important;
        }

        #controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .turn-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #turnLabel {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin: 0;
            min-width: 80px;
            text-align: center;
        }

        .info-text {
            color: #ccc;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            canvas {
                width: 100%;
                height: 100%;
            }

            #controls {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: center;
                width: 100%;
            }

            #turnLabel {
                margin: 10px 0;
                font-size: 16px;
            }

            button {
                width: 60px;
                padding: 10px 20px;
            }

            table {
                font-size: 24px;
            }

            th, td {
                padding: 8px 12px;
                word-spacing: 12px;
            }

            .container {
                padding: 0 10px;
            }

            .game-info, .hints-table {
                padding: 15px;
                margin: 15px 0;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            canvas {
                width: 100%;
                height: 100%;
            }

            button {
                width: 60px;
                padding: 8px 16px;
                font-size: 14px;
            }

            table {
                font-size: 18px;
            }

            th, td {
                padding: 6px 8px;
                word-spacing: 4px;
            }
        }

        .loading {
            color: #007bff;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            background-color: #2d1b1b;
            border: 1px solid #dc3545;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('game_id') || 'default';
    </script>
</head>
<body>
    <div class="container">
        <h1>Backgammon Game Analysis</h1>
        <div id="players-info"></div>
        <canvas id="boardCanvas" width="800" height="800"></canvas>

        <div id="controls">
            <button onclick="prevTurn()" id="prevBtn">←</button>
            <span id="turnLabel">Ход 0</span>
            <button onclick="nextTurn()" id="nextBtn">→</button>
        </div>
        <div class="game-info">
            <div id="info" class="info-text"></div>
        </div>

        <div class="hints-table">
            <div id="hints"></div>
        </div>
    </div>

    <script>
        if (window.Telegram) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        let data = [];
        let dataLoaded = false;
        const infoDiv = document.getElementById('info');
        const playersInfoDiv = document.getElementById('players-info');
        infoDiv.innerHTML = '<div class="loading">Loading game data...</div>';

        fetch(`/api/analysis/${gameId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(json => {
                data = json.filter(item => item.turn !== undefined);
                data = data.filter(it => (Array.isArray(it.moves) && it.moves.length > 0) || it.action === 'win');
                
                if (data.length > 0) {
                    const redPlayer = data.find(item => item.player === 'Red' || item.player === 'red')?.player_name || 'Unknown';
                    const blackPlayer = data.find(item => item.player === 'Black' || item.player === 'black')?.player_name || 'Unknown';
                    playersInfoDiv.innerHTML = `Белые: ${redPlayer} – Черные: ${blackPlayer}`;
                    dataLoaded = true;
                    console.log('Data loaded:', data);
                    console.log('First turn data:', data[0]);
                    console.log('First turn moves:', data[0]?.moves);
                    if (data[0]?.action === 'skip') {
                        current = 1;
                    }
                    if (imagesLoaded === 9) {
                        render(current);
                        updateButtons();
                        infoDiv.innerHTML = '';
                    } else {
                        console.log('Waiting for images to load before rendering');
                    }
                } else {
                    infoDiv.innerHTML = '<div class="error">No game data found for this game ID.</div>';
                }
            })
            .catch(error => {
                console.error('Error loading JSON:', error);
                infoDiv.innerHTML = '<div class="error">Error loading game data. Please check the game ID and try again.</div>';
            });

        let current = 0;
        const canvas = document.getElementById('boardCanvas');
        const ctx = canvas.getContext('2d');

        const boardImg = new Image();
        boardImg.src = '/static/board.png';

        const blackImg = new Image();
        blackImg.src = '/static/black_checker.png';

        const whiteImg = new Image();
        whiteImg.src = '/static/white_checker.png';

        const Dice1 = new Image();
        Dice1.src = '/static/Dice1.png';
        const Dice2 = new Image();
        Dice2.src = '/static/Dice2.png';
        const Dice3 = new Image();
        Dice3.src = '/static/Dice3.png';
        const Dice4 = new Image();
        Dice4.src = '/static/Dice4.png';
        const Dice5 = new Image();
        Dice5.src = '/static/Dice5.png';
        const Dice6 = new Image();
        Dice6.src = '/static/Dice6.png';

        let imagesLoaded = 0;
        const checkImagesLoaded = () => {
            imagesLoaded++;
            console.log('Images loaded:', imagesLoaded);
            if (imagesLoaded === 9 && dataLoaded) {
                console.log('All images and data loaded, rendering turn', current);
                render(current);
                updateButtons();
                infoDiv.innerHTML = '';
            }
        };

        boardImg.onload = checkImagesLoaded;
        blackImg.onload = checkImagesLoaded;
        whiteImg.onload = checkImagesLoaded;
        Dice1.onload = checkImagesLoaded;
        Dice2.onload = checkImagesLoaded;
        Dice3.onload = checkImagesLoaded;
        Dice4.onload = checkImagesLoaded;
        Dice5.onload = checkImagesLoaded;
        Dice6.onload = checkImagesLoaded;

        // Обработка ошибок загрузки изображений
        [boardImg, blackImg, whiteImg, Dice1, Dice2, Dice3, Dice4, Dice5, Dice6].forEach(img => {
            img.onerror = () => {
                console.error(`Failed to load image: ${img.src}`);
                infoDiv.innerHTML = '<div class="error">Error loading game assets. Please try again later.</div>';
            };
        });

        const diceImages = {
            1: Dice1,
            2: Dice2,
            3: Dice3,
            4: Dice4,
            5: Dice5,
            6: Dice6
        };

        function getX(point) {
            if (point >= 13 && point <= 18) {
                const baseX = 50 + (point - 13) * 60;
                return baseX - (point === 13 ? 8 : 0);
            } else if (point >= 19 && point <= 24) {
                return 450 + (point - 19) * 60;
            } else if (point >= 7 && point <= 12) {
                const baseX = 50 + (12 - point) * 60;
                return baseX - (point === 12 ? 4 : 0);
            } else if (point >= 1 && point <= 6) {
                return 450 + (6 - point) * 60;
            }
            return 0;
        }

        function getBaseY(point) {
            return (point > 12) ? 70 : 690; 
        }

        function getDy(point) {
            return (point > 12) ? 55 : -55; 
        }

        function drawCheckers(player, img, positions, currentPlayer) {
            ctx.font = 'bold 18px Arial'; // Единый размер шрифта
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // Draw position numbers only for the current player
            if (player === currentPlayer) {
                for (let point = 1; point <= 24; point++) {
                    const x = getX(point);
                    let y = getBaseY(point);
                    const dy = getDy(point);

                    let displayPoint = point;
                    if (player === 'red') {
                        displayPoint = 25 - point; // Red sees points inverted (24 at bottom-left, 1 at top-right)
                    } else if (player === 'black') {
                        displayPoint = point; // Black sees points starting from top-right (1 at top-right, 24 at bottom-left)
                    }
                    let numberY;
                    if (point > 12) {
                        numberY = y - 50; // Above for upper half
                    } else {
                        numberY = y + 50; // Below for lower half
                    }
                    ctx.fillText(displayPoint, x, numberY);
                }
            }

            for (let pointStr in positions) {
                if (pointStr === 'bar' || pointStr === 'off') continue;
                const point = parseInt(pointStr);
                let count = positions[pointStr];
                const x = getX(point);
                let y = getBaseY(point);
                const dy = getDy(point);

                for (let i = 0; i < Math.min(count, 6); i++) {
                    ctx.drawImage(img, x - 31.25, y + (i * dy) - 31.25, 62.5, 62.5);
                }

                if (count > 6) {
                    const lastCheckerY = y + (5 * dy);
                    ctx.fillText(`(${count})`, x + 30, lastCheckerY + 5);
                }
            }

            const barX = 400;
            const barY = (player === 'black') ? 220 : 520;
            if (positions.bar && positions.bar !== 0) {
                let y = barY;
                const dy = (player === 'black') ? 55 : -55;
                ctx.fillText('Bar', barX, y - 10);
                for (let i = 0; i < Math.min(Math.abs(positions.bar), 6); i++) {
                    ctx.drawImage(img, barX - 31.25, y + (i * dy) - 31.25, 62.5, 62.5);
                }
                if (Math.abs(positions.bar) > 6) {
                    const lastCheckerY = y + (5 * dy);
                    ctx.fillText(`(${Math.abs(positions.bar)})`, barX + 30, lastCheckerY + 5);
                }
            }

            const offX = (player === 'black') ? 20 : 760;
            const offY = 400;
            if (positions.off && positions.off !== 0) {
                ctx.fillText('Off', offX, offY - 10);
                ctx.fillText(`${positions.off}`, offX, offY + 40);
            }
        }

        function render(turn) {
            if (!data || !data[turn]) {
                console.error('No data for turn:', turn);
                document.getElementById('info').innerHTML = '<div class="error">No data available for this turn.</div>';
                return;
            }

            current = turn;
            document.getElementById('turnLabel').innerText = `Ход ${data[turn].turn || 'End'}`;
            console.log('Rendering turn:', turn, 'Data:', data[turn]);

            ctx.clearRect(0, 0, 800, 800); 
            ctx.drawImage(boardImg, 0, 0, 800, 800); 

            let redPositions, blackPositions;
            if (turn === 0) {
                redPositions = { '24': 2, '6': 5, '8': 3, '13': 5, 'bar': 0, 'off': 0 };
                blackPositions = { '1': 2, '19': 5, '17': 3, '12': 5, 'bar': 0, 'off': 0 };
            } else {
                redPositions = data[turn].positions['red'];
                blackPositions = data[turn].positions['black'];
            }

            const currentPlayer = data[turn].player.toLowerCase();
            drawCheckers('red', whiteImg, redPositions, currentPlayer);
            drawCheckers('black', blackImg, blackPositions, currentPlayer);

            const item = data[turn];
            if (item.dice && item.dice.length >= 2 && !['double', 'take', 'win'].includes(item.action)) {
                const [d1, d2] = item.dice;
                const diceY = 400;

                let diceX1, diceX2;
                if (item.player === 'Red') {
                    diceX1 = 530; // кубики справа для красных
                    diceX2 = 620;
                } else {
                    diceX1 = 130; // кубики слева для черных
                    diceX2 = 220;
                }

                if (diceImages[d1]) ctx.drawImage(diceImages[d1], diceX1, diceY, 80, 80);
                if (diceImages[d2]) ctx.drawImage(diceImages[d2], diceX2, diceY, 80, 80);
            }
            let info = '';
            if (item.action === 'double') {
                info = `<strong>Действие:</strong> Удвоение (${item.cube})`;
            } else if (item.action === 'take') {
                info = `<strong>Действие:</strong> Принятие`;
            } else if (item.action === 'win') {
                info = `<strong>Действие:</strong> Победа (${item.points} очков)`;
            } else if (item.moves && item.moves.length > 0) {
                info = `<strong>Ход:</strong> ${item.moves.map(m => {
                    let from = m.from;
                    let to = m.to;
                    if (currentPlayer === 'red') {
                        from = from === 25 ? 'bar' : (from === 0 ? 'off' : 25 - from);
                        to = to === 0 ? 'off' : 25 - to;
                    }
                    return `${from}/${to}${m.hit ? '*' : ''}`;
                }).join(' ')}`;
                console.log('Moves for turn:', item.moves);
            } else {
                info = '<div class="info-text">No moves available for this turn.</div>';
                console.warn('No moves for turn:', turn, item);
            }
            setTimeout(() => {
                document.getElementById('info').innerHTML = info;
                console.log('Info set to:', info);
                console.log('Actual info div content:', document.getElementById('info').innerHTML);
            }, 0);

            let tableHtml = '<table><tr><th>Действие</th><th>Эквити</th></tr>';
            if (item.hints && item.hints.length > 0 && item.hints[0].type === 'cube') {
                const bestAction = item.hints[0].cubeful_equities.find(eq => eq.idx === 1);
                const bestAction1 = bestAction.action_1;
                const bestAction2 = bestAction.action_2;
                (item.hints[0].cubeful_equities || []).slice(0, 3).forEach((hint, index) => {
                    const eq = hint.eq ? hint.eq.toFixed(3) : '-';
                    let displayAction = hint.action_1;
                    if (hint.action_2) {
                        displayAction += `, ${hint.action_2}`;
                    }
                    let rowClass = '';
                    if (item.gnu_move === 'Double') {
                        if (index === 0) {
                            rowClass = 'hint-best';
                        } else if (index === 1) {
                            rowClass = 'hint-good';
                        } else {
                            rowClass = 'hint-poor';
                        }
                    } else if (item.gnu_move !== 'Double') {
                        if (hint.action_2 === bestAction2) {
                            if (index === 0) {
                                rowClass = 'hint-best';
                            } else if (index === 1) {
                                rowClass = 'hint-good';
                            } else {
                                rowClass = 'hint-poor';
                            }
                        }
                    }
                    tableHtml += `<tr class="${rowClass}"><td>${displayAction}</td><td>${eq}</td></tr>`;
                });
            } else {
                tableHtml = '<table><tr><th>Ход</th><th>Вероятности, %</th><th>Эквити</th></tr>';
                (item.hints || []).slice(0, 3).forEach((hint, index) => {
                    if (hint.probs && hint.probs.length >= 2) {
                        const prob1 = hint.probs[0] ? (hint.probs[0] * 100).toFixed(1) : '-';
                        const prob2 = hint.probs[1] ? (hint.probs[1] * 100).toFixed(1) : '-';
                        const eq = hint.eq ? hint.eq.toFixed(3) : '-';
                        let move = hint.move || '-';
                        if (currentPlayer === 'red') {
                            move = move.split(' ').map(m => {
                                let [from, to] = m.split('/');
                                from = from === 'bar' ? 'bar' : (from === 'off' ? 'off' : 25 - parseInt(from));
                                to = to === 'off' ? 'off' : 25 - parseInt(to);
                                return `${from}/${to}`;
                            }).join(' ');
                        }
                        let rowClass = '';
                        if (item.gnu_move && hint.move === item.gnu_move) {
                            if (index === 0) {
                                rowClass = 'hint-best';
                            } else if (index >= 1 && index <= 4) {
                                rowClass = 'hint-good';
                            } else {
                                rowClass = 'hint-poor';
                            }
                        }
                        tableHtml += `<tr class="${rowClass}"><td>${move}</td><td>${prob1} ${prob2}</td><td>${eq}</td></tr>`;
                    }
                });
            }
            tableHtml += '</table>';
            document.getElementById('hints').innerHTML = tableHtml;
        }

        function prevTurn() {
            if (current > 0) {
                render(current - 1);
                updateButtons();
            }
        }

        function nextTurn() {
            if (current < data.length - 1) {
                render(current + 1);
                updateButtons();
            }
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = current <= 0;
            nextBtn.disabled = current >= data.length - 1;
        }
    </script>
</body>
</html>