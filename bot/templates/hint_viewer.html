<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Hint Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #2c2c2c;
            color: white;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        canvas {
            background: #444;
            border: 1px solid #555;
            border-radius: 10px;
        }
        table {
            margin: 10px auto;
            border-collapse: collapse;
            background: #333;
            color: white;
        }
        th, td {
            border: 1px solid #666;
            padding: 5px 10px;
        }
        .hint-best { background: #4caf50; }
        .hint-good { background: #2196f3; }
        .hint-poor { background: #f44336; }
        .controls {
            margin: 10px;
        }
        button {
            margin: 5px;
            padding: 5px 15px;
            background: #555;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #777;
        }
        #info {
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h2>Backgammon Hint Viewer</h2>
    <div id="turnLabel">Ход —</div>
    <canvas id="board" width="800" height="700"></canvas>
    <div id="info"><em>Загрузка...</em></div>

    <div id="hints"></div>

    <div class="controls">
        <button id="prevBtn">◀ Предыдущий</button>
        <button id="nextBtn">Следующий ▶</button>
    </div>

    <script>
        const canvas = document.getElementById('board');
        const ctx = canvas.getContext('2d');
        const infoDiv = document.getElementById('info');
        const boardImg = new Image();
        const blackImg = new Image();
        const whiteImg = new Image();
        const Dice1 = new Image(), Dice2 = new Image(), Dice3 = new Image(),
              Dice4 = new Image(), Dice5 = new Image(), Dice6 = new Image();
        const diceImages = [null, Dice1, Dice2, Dice3, Dice4, Dice5, Dice6];
        const images = [boardImg, blackImg, whiteImg, Dice1, Dice2, Dice3, Dice4, Dice5, Dice6];

        boardImg.src = 'board.png';
        blackImg.src = 'black.png';
        whiteImg.src = 'white.png';
        Dice1.src = 'dice1.png';
        Dice2.src = 'dice2.png';
        Dice3.src = 'dice3.png';
        Dice4.src = 'dice4.png';
        Dice5.src = 'dice5.png';
        Dice6.src = 'dice6.png';

        let data = [];
        let current = 0;
        let dataLoaded = false;
        let imagesReady = false;
        let imagesLoaded = 0;

        const markImage = () => {
            imagesLoaded++;
            if (imagesLoaded >= images.length) {
                imagesReady = true;
                maybeRenderInitial();
            }
        };

        images.forEach(img => {
            img.onload = markImage;
            img.onerror = markImage;
        });

        fetch('data.json')
            .then(r => r.json())
            .then(json => {
                data = json;
                if (data.length > 0) {
                    dataLoaded = true;
                    maybeRenderInitial();
                } else {
                    infoDiv.innerHTML = '<em>Нет данных</em>';
                }
            })
            .catch(() => {
                infoDiv.innerHTML = '<em>Ошибка загрузки data.json</em>';
            });

        function maybeRenderInitial() {
            if (dataLoaded && imagesReady && data.length > 0) {
                render(0);
                updateButtons();
            }
        }

        function getX(point) {
            const pos = [
                null, 735, 680, 625, 570, 515, 460,
                345, 290, 235, 180, 125, 70,
                70, 125, 180, 235, 290, 345,
                460, 515, 570, 625, 680, 735
            ];
            return pos[point] || 400;
        }

        function getBaseY(point) {
            return point >= 13 ? 90 : 610;
        }

        function getDy(point) {
            return point >= 13 ? 55 : -55;
        }

        function drawCheckers(player, img, item) {
            const prevIndex = current > 0 ? current - 1 : 0;
            const base = (current === 0) ? item : data[prevIndex];
            const positions = (base && base.positions && base.positions[player]) ?
                base.positions[player] : { bar: 0, off: 0 };

            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = '#ffffff';
            for (let pointStr in positions) {
                if (!Object.prototype.hasOwnProperty.call(positions, pointStr)) continue;
                if (pointStr === 'bar' || pointStr === 'off') continue;
                const point = parseInt(pointStr);
                if (isNaN(point)) continue;
                let count = positions[pointStr];
                const x = getX(point);
                let y = getBaseY(point);
                const dy = getDy(point);
                for (let i = 0; i < Math.min(count, 6); i++) {
                    if (img.complete) ctx.drawImage(img, x - 31.25, y + (i * dy) - 31.25, 62.5, 62.5);
                }
                if (count > 6) {
                    const lastCheckerY = y + (5 * dy);
                    ctx.fillText(`(${count})`, x + 30, lastCheckerY + 5);
                }
            }

            // bar
            if ((positions.bar || 0) > 0) {
                const barX = 400;
                const barY = (player === 'black') ? 220 : 520;
                const dy = (player === 'black') ? 55 : -55;
                for (let i = 0; i < Math.min(positions.bar, 6); i++) {
                    if (img.complete) ctx.drawImage(img, barX - 31.25, barY + (i * dy) - 31.25, 62.5, 62.5);
                }
                if (positions.bar > 6) {
                    const lastCheckerY = barY + (5 * dy);
                    ctx.fillText(`(${positions.bar})`, barX + 20, lastCheckerY + 5);
                }
            }

            // off
            if ((positions.off || 0) > 0) {
                const offX = (player === 'black') ? 20 : 760;
                const offY = 400;
                ctx.fillText('Off:', offX, offY);
                ctx.fillText(`${positions.off}`, offX, offY + 40);
            }
        }

        function render(turn) {
            if (!data || data.length === 0) return;
            if (turn < 0) turn = 0;
            if (turn >= data.length) turn = data.length - 1;
            current = turn;

            const item = data[turn] || {};
            document.getElementById('turnLabel').innerText = `Ход ${item.turn ?? '—'}`;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (boardImg.complete) ctx.drawImage(boardImg, 0, 0, canvas.width, canvas.height);

            drawCheckers('red', whiteImg, item);
            drawCheckers('black', blackImg, item);

            if (item.dice && item.dice.length >= 2) {
                const [die1, die2] = item.dice;
                const diceY = item.player === 'black' ? 200 : 500;
                if (diceImages[die1]?.complete) ctx.drawImage(diceImages[die1], 370, diceY, 80, 80);
                if (diceImages[die2]?.complete) ctx.drawImage(diceImages[die2], 460, diceY, 80, 80);
            }

            let info = '';
            if (item.moves && Array.isArray(item.moves) && item.moves.length > 0) {
                info = `<strong>Ход:</strong> ${item.moves.map(m => `${m.from}/${m.to}${m.hit ? '*' : ''}`).join(' ')}`;
            } else if (item.turn === undefined) {
                info = '<em>Нет данных о ходе</em>';
            } else {
                info = '<em>Ход отсутствует</em>';
            }
            infoDiv.innerHTML = info;

            let tableHtml = '<table><tr><th>Ход</th><th>Вероятности, %</th><th>Эквити</th></tr>';
            (item.hints || []).slice(0, 3).forEach((hint, index) => {
                const prob1 = (hint.probs && hint.probs[0] != null) ? hint.probs[0].toFixed(3) : '-';
                const prob2 = (hint.probs && hint.probs[1] != null) ? hint.probs[1].toFixed(3) : '-';
                const eq = (hint.eq != null) ? hint.eq.toFixed(3) : '-';
                let rowClass = '';
                if (item.gnu_move && hint.move === item.gnu_move) {
                    rowClass = index === 0 ? 'hint-best' : (index <= 4 ? 'hint-good' : 'hint-poor');
                }
                tableHtml += `<tr class="${rowClass}"><td>${hint.move || '-'}</td><td>${prob1} ${prob2}</td><td>${eq}</td></tr>`;
            });
            tableHtml += '</table>';
            document.getElementById('hints').innerHTML = tableHtml;
        }

        function updateButtons() {
            document.getElementById('prevBtn').disabled = current <= 0;
            document.getElementById('nextBtn').disabled = current >= data.length - 1;
        }

        document.getElementById('prevBtn').onclick = () => {
            if (current > 0) render(current - 1);
            updateButtons();
        };

        document.getElementById('nextBtn').onclick = () => {
            if (current < data.length - 1) render(current + 1);
            updateButtons();
        };
    </script>
</body>
</html>
