<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backgammon Board Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background-color: #1a1a1a;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1 {
            display: none;
        }

        canvas {
            border: 2px solid #333;
            border-radius: 8px;
            background-color: #2a2a2a;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }

        .game-info {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 10px;
            margin: 0;
            border: 1px solid #444;
            width: 30%;
            display: block;
        }

        #top-row {
            margin: 0px 0;
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            align-items: center;
            width: 100%;
        }

        #controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            width: 100%;
            flex-wrap: wrap;
        }

        .turn-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        select {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: white;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 5px;
        }

        #prevBtn,
        #nextBtn,
        #invertBtn {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 40px;
            height: 40px;
            padding: 0;
            color: transparent;
            background-color: transparent;
            border: none;
        }

        #prevBtn:hover,
        #nextBtn:hover,
        #invertBtn:hover {
            background-color: transparent;
        }

        #prevBtn:disabled,
        #nextBtn:disabled,
        #invertBtn:disabled {
            opacity: 0.5;
            background-color: transparent;
        }

        #turnLabel {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin: 0;
            min-width: 40px;
            text-align: center;
        }

        .info-text {
            color: #ccc;
            margin: 5px 0;
        }

        .board-footer {
            position: relative;
            margin-top: -20px;
        }

        .move-info {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
        }

        .pips-below-board {
            position: absolute;
            right: 0;
            top: 0;
            margin: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .pips-above-board,
            .pips-below-board {
                font-size: 16px;
                padding: 8px 16px;
            }

            canvas {
                width: 100%;
                height: 100%;
            }

            #top-row {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: space-between;
                width: 100%;
            }

            #controls {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: center;
                width: 100%;
            }

            #turnLabel {
                margin: 5px 0;
                font-size: 16px;
            }

            #top-row {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: space-between;
                width: 100%;
            }

            button {
                width: 60px;
                padding: 10px 20px;
            }

            .container {
                padding: 0 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Backgammon Board Viewer</h1>

        <div id="top-row">
            <div id="controls">
                <button id="prevBtn" title="Previous Move">
                    <img src="/static/left.png" alt="Previous" style="width: 100%; height: 100%;">
                </button>
                <div class="turn-display">
                    <span id="turnLabel">1</span>
                </div>
                <button id="nextBtn" title="Next Move">
                    <img src="/static/right.png" alt="Next" style="width: 100%; height: 100%;">
                </button>
                <button id="invertBtn" title="Invert Board">
                    <img src="/static/change_color.png" alt="Invert" style="width: 100%; height: 100%;">
                </button>
            </div>
            <select id="gameSelect">
                <option value="0">Game 1</option>
            </select>
        </div>

        <canvas id="boardCanvas" width="800" height="600"></canvas>

        <div class="board-footer">
            <div class="move-info" id="moveInfo">Initial Position</div>
            <div class="pips-below-board">
                <div class="game-info" id="players-info">
                    <div>White: Player 1 (0)</div>
                    <div>Black: Player 2 (0)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let availableGames = [];
        let current = 0;
        let currentGameNum = 1;
        let inverted = false;
        let dataLoaded = false;

        const canvas = document.getElementById('boardCanvas');
        const ctx = canvas.getContext('2d');

        // Load images
        const boardImg = new Image();
        boardImg.src = '/static/board.png';
        const whiteChecker = new Image();
        whiteChecker.src = '/static/white_checker.png';
        const blackChecker = new Image();
        blackChecker.src = '/static/black_checker.png';

        // Get game_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const game_id = urlParams.get('game_id');

        if (!game_id) {
            console.error('No game_id provided in URL');
            alert('No game_id provided in URL');
        }

        // Load data
        fetch(`/api/games/${game_id}`)
            .then(response => response.json())
            .then(jsonData => {
                let gamesArray;
                if (Array.isArray(jsonData)) {
                    gamesArray = jsonData;
                } else if (jsonData.games && Array.isArray(jsonData.games)) {
                    gamesArray = jsonData.games;
                } else if (jsonData.detail) {
                    alert('Error: ' + jsonData.detail);
                    return;
                } else {
                    console.error('Unexpected data format:', jsonData);
                    return;
                }
                data = gamesArray[0].turns; // Default to first game
                availableGames = gamesArray.map((game, index) => ({
                    game_number: index + 1,
                    turns: game.turns,
                    first_player: game.first.name,
                    second_player: game.second.name,
                    first_score: game.first.score,
                    second_score: game.second.score
                }));
                dataLoaded = true;
                updateGameSelect();
                updateButtons();
                drawBoard();
                updateInfo();
            })
            .catch(error => {
                console.error('Error loading games data:', error);
                alert('Error loading games data: ' + error.message);
            });

        function updateGameSelect() {
            const gameSelect = document.getElementById('gameSelect');
            gameSelect.innerHTML = '';
            availableGames.forEach(game => {
                const option = document.createElement('option');
                option.value = game.game_number - 1;
                option.textContent = `Game ${game.game_number}`;
                gameSelect.appendChild(option);
            });
        }

        function drawBoard() {
            if (!dataLoaded) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw board
            ctx.drawImage(boardImg, 0, 0, canvas.width, canvas.height);

            const positions = inverted ? data[current].inverted_positions : data[current].positions;

            // Draw checkers
            drawCheckers(positions);
        }

        function drawCheckers(positions) {
            const pointWidth = canvas.width / 26; // 26 points + bar
            const checkerRadius = pointWidth / 2 - 2;

            for (let point = 1; point <= 24; point++) {
                const x = getPointX(point);
                const y = getPointY(point);

                // Draw white checkers (first player)
                const whiteCount = positions.first[String(point)] || 0;
                for (let i = 0; i < whiteCount; i++) {
                    const checkerY = y - (i * (checkerRadius * 2 + 2));
                    ctx.drawImage(whiteChecker, x - checkerRadius, checkerY - checkerRadius, checkerRadius * 2, checkerRadius * 2);
                }

                // Draw black checkers (second player)
                const blackCount = positions.second[String(point)] || 0;
                for (let i = 0; i < blackCount; i++) {
                    const checkerY = y + (i * (checkerRadius * 2 + 2));
                    ctx.drawImage(blackChecker, x - checkerRadius, checkerY - checkerRadius, checkerRadius * 2, checkerRadius * 2);
                }
            }

            // Draw bar checkers
            const barX = canvas.width / 2;
            const barYTop = canvas.height / 2 - 50;
            const barYBottom = canvas.height / 2 + 50;

            const barWhite = positions.first.bar || 0;
            for (let i = 0; i < barWhite; i++) {
                ctx.drawImage(whiteChecker, barX - checkerRadius, barYTop - (i * (checkerRadius * 2 + 2)) - checkerRadius, checkerRadius * 2, checkerRadius * 2);
            }

            const barBlack = positions.second.bar || 0;
            for (let i = 0; i < barBlack; i++) {
                ctx.drawImage(blackChecker, barX - checkerRadius, barYBottom + (i * (checkerRadius * 2 + 2)) - checkerRadius, checkerRadius * 2, checkerRadius * 2);
            }
        }

        function getPointX(point) {
            if (point <= 12) {
                return (13 - point) * (canvas.width / 13);
            } else {
                return (point - 12) * (canvas.width / 13);
            }
        }

        function getPointY(point) {
            if (point <= 12) {
                return canvas.height - 50;
            } else {
                return 50;
            }
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (dataLoaded) {
                prevBtn.disabled = current === 0;
                nextBtn.disabled = current === data.length - 1;
            } else {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            }
        }

        function updateInfo() {
            if (!dataLoaded) return;

            const turnLabel = document.getElementById('turnLabel');
            turnLabel.textContent = current + 1;

            const moveInfo = document.getElementById('moveInfo');
            const turn = data[current];
            if (turn.moves && turn.moves.length > 0) {
                const movesStr = turn.moves.map(m => `${m.from}/${m.to}${m.hit ? '*' : ''}`).join(' ');
                moveInfo.textContent = `${turn.turn}: ${movesStr}`;
            } else if (turn.action) {
                moveInfo.textContent = `${turn.turn}: ${turn.action}`;
            } else {
                moveInfo.textContent = 'Initial Position';
            }

            const playersInfo = document.getElementById('players-info');
            const game = availableGames.find(g => g.game_number === currentGameNum);
            if (game) {
                playersInfo.innerHTML = `
                    <div>White: ${game.first_player} (${game.first_score})</div>
                    <div>Black: ${game.second_player} (${game.second_score})</div>
                `;
            }
        }

        // Event listeners
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (current > 0) {
                current--;
                drawBoard();
                updateButtons();
                updateInfo();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (current < data.length - 1) {
                current++;
                drawBoard();
                updateButtons();
                updateInfo();
            }
        });

        document.getElementById('invertBtn').addEventListener('click', () => {
            inverted = !inverted;
            drawBoard();
        });

        document.getElementById('gameSelect').addEventListener('change', (e) => {
            const gameIndex = parseInt(e.target.value);
            currentGameNum = gameIndex + 1;
            data = availableGames[gameIndex].turns;
            current = 0;
            inverted = false;
            drawBoard();
            updateButtons();
            updateInfo();
        });

        // Draw board when images are loaded
        let imagesLoaded = 0;
        const totalImages = 3;

        function imageLoaded() {
            imagesLoaded++;
            if (imagesLoaded === totalImages && dataLoaded) {
                drawBoard();
            }
        }

        boardImg.onload = imageLoaded;
        whiteChecker.onload = imageLoaded;
        blackChecker.onload = imageLoaded;
    </script>
</body>

</html>